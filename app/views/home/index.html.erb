<%= javascript_include_tag "strophe" %>
<%= javascript_include_tag "strophe.muc" %>
<% if user_signed_in? %>
  <%= current_user.email %>
<% else %>
  lll
<% end %>

<script>
var BOSH_SERVICE = 'http://sand.chinacloudapp.cn/http-bind/';
var connection = null;

function onConnect(status)
{
  if (status == Strophe.Status.CONNECTING) {
    console.log('Strophe is connecting.');
  } else if (status == Strophe.Status.CONNFAIL) {
    console.log('Strophe failed to connect.');
    $('#connect').get(0).value = 'connect';
  } else if (status == Strophe.Status.DISCONNECTING) {
    console.log('Strophe is disconnecting.');
  } else if (status == Strophe.Status.DISCONNECTED) {
    console.log('Strophe is disconnected at: ' + (new Date()).toString());
  } else if (status == Strophe.Status.CONNECTED) {
    connection.addHandler(onMessage, null, 'message', null, null,  null);
    window.strophe_connected = true;
    connection.send($pres().c('status', "online"));
    join_room()
  }

}

function room_message(m) {
  console.log(m);
  //多次调用要返回true，不然只调用一次
  return true;
}

function on_presence(m) {
  console.log(m);
}
function on_roster(m) {
  console.log(m);
}

function join_room() {

  connection.muc.join("abc@conference.sand.chinacloudapp.cn", "15002", room_message,  on_presence, on_roster, "000000");

/*
  var userName = "15002",
  serverName = "sand.chinacloudapp.com",
  userJid = userName + '@' + serverName,
  roomJid = 'abc' + '@conference.' + serverName,
  iq;
  //send presence first for creating room
  var d = $pres({'from': userJid, 'to': roomJid + '/' + userName})
  connection.send(d.tree());

  iq = $iq({
    to: roomJid,
    type: 'set'
  }).c("query", {
    xmlns: Strophe.NS.MUC
  });
  iq.c("x", {
    xmlns: "jabber:x:data",
    type: "submit"
  });

  //send configuration you want
  iq.c('field', { 'var': 'FORM_TYPE' }).c('value').t('http://jabber.org/protocol/muc#roomconfig').up().up();
  iq.c('field', { 'var': 'muc#roomconfig_publicroom' }).c('value').t('1').up().up();

  connection.sendIQ(iq.tree(), function () { console.log('success'); }, function (err) { console.log('error', err); });
 */
}

function onMessage(msg) {
  console.log(msg)
  return true
}

$(document).ready(function () {
  connection = new Strophe.Connection(BOSH_SERVICE);
  jid =   "15002@sand.chinacloudapp.cn"
  connection.connect(jid, '000000', onConnect);
});
</script>


